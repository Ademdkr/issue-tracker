name: CD - Continuous Deployment

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: production
      url: https://issue-tracker.ademdokur.dev

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”¨ Generate Prisma Client
        run: npx prisma generate --schema=apps/backend/prisma/schema.prisma

      - name: ğŸ—ï¸ Build Backend
        run: npx nx build backend --configuration=production

      - name: ğŸ—ï¸ Build Frontend
        run: npx nx build frontend --configuration=production

      - name: ğŸš€ Deploy to Render
        env:
          BACKEND_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}
          FRONTEND_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}
        run: |
          echo "ğŸš€ Triggering Render deployments..."
          
          if [ -z "$BACKEND_HOOK" ] || [ -z "$FRONTEND_HOOK" ]; then
            echo "âŒ Deploy hooks not configured!"
            echo "Configure RENDER_DEPLOY_HOOK_BACKEND and RENDER_DEPLOY_HOOK_FRONTEND in GitHub Secrets"
            exit 1
          fi
          
          curl -X POST "$BACKEND_HOOK"
          echo "âœ… Backend deployment triggered"
          
          curl -X POST "$FRONTEND_HOOK"
          echo "âœ… Frontend deployment triggered"
          
          echo "â³ Waiting 300s for deployment..."
          sleep 300

      - name: ğŸ¥ Health Check Backend
        run: |
          echo "ğŸ¥ Checking backend health..."
          if curl --fail --retry 5 --retry-delay 15 --max-time 30 \
            https://issue-tracker-backend-23d7.onrender.com/api/health; then
            echo "âœ… Backend is healthy!"
          else
            echo "âš ï¸ Health check failed (normal for Free Tier cold starts)"
            echo "Check: https://dashboard.render.com"
          fi

      - name: ğŸ¥ Health Check Frontend
        run: |
          echo "ğŸ¥ Checking frontend..."
          if curl --fail --max-time 30 https://issue-tracker.ademdokur.dev/health; then
            echo "âœ… Frontend is healthy!"
          else
            echo "âš ï¸ Frontend check failed"
          fi

      - name: âœ… Deployment Complete
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Frontend: https://issue-tracker.ademdokur.dev"
          echo "ğŸ”§ Backend: https://issue-tracker-backend-23d7.onrender.com"
          echo "ğŸ“Š Dashboard: https://dashboard.render.com"
        run: |
          echo "âœ… Production deployment successful!"
          echo "Frontend: https://issue-tracker.ademdokur.dev"
          echo "API: https://issue-tracker.ademdokur.dev/api"
